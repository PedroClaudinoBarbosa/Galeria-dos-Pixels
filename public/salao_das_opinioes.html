<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeria dos Pixels</title>
    <link rel="stylesheet" href="styles/style_salao_das_opinioes.css">
</head>
<body>
    <div class="galeria">
        <div class="container">
            <div class="nav_bar">
                    <div class="usuario">
                    <img src="../assets/imgs/kratos.webp" alt="">
                    <h3 id="b_usuario"></h3>
                    </div>
                
                    <button onclick="salao()">Salão Principal</button>
                    <button onclick="linha()">Linha do Tempo</button>
                    <button onclick="hardware()">Hall do Hardware & Software</button>         
                    <button onclick="salao()">Biblioteca das Curiosidades</button>                    
            </div>
        </div>
        <div class="perguntas">
            <img src="../assets/imgs/ace.webp" alt="Consoles de Video Game" class="imagem_abaixo fade-in">
            <h1>Tribunal das Opiniões</h1>
            <div class="card">
            <p>Genêro de Videogame favorito:</p>
            <select id="generoFavorito" name="genero" required onchange="generoSelecionado(this)">
            <option value="0" selected>Nenhum</option>

            <optgroup label="Ação">
                <option value=1>Plataforma</option>
                <option value=2>Hack and Slash</option>
                <option value=3>Beat 'em up</option>
                <option value=4>Run and Gun</option>
            </optgroup>

            <optgroup label="Aventura">
                <option value=5>Aventura de Ação</option>
                <option value=6>Point and Click</option>
                <option value=7>Metroidvania</option>
                <option value=8>Survival</option>
            </optgroup>

            <optgroup label="RPG (Role-Playing Game)">
                <option value=9>RPG de Turno</option>
                <option value=10>RPG de Ação</option>
                <option value=11>JRPG</option>
                <option value=12>Roguelike / Roguelite</option>
                <option value=13>MMORPG</option>
            </optgroup>

            <optgroup label="Estratégia">
                <option value=14>RTS (Tempo Real)</option>
                <option value=15>Tático por Turno</option>
                <option value=16>Defesa de Torre</option>
                <option value=17>4X</option>
            </optgroup>

            <optgroup label="Simulação">
                <option value=18>Simulação de Vida</option>
                <option value=19>Construção e Gestão</option>
                <option value=20>Simulação de Voo</option>
                <option value=21>Simulador Realista</option>
            </optgroup>

            <optgroup label="Esporte e Corrida">
                <option value=22>Futebol</option>
                <option value=23>Basquete</option>
                <option value=24>Corrida Arcade</option>
                <option value=25>Simulação de Corrida</option>
            </optgroup>

            <optgroup label="Tiro (Shooter)">
                <option value=26>FPS</option>
                <option value=27>TPS</option>
                <option value=28>Shoot 'em up</option>
                <option value=29>Battle Royale</option>
            </optgroup>

            <optgroup label="Puzzle e Party Game">
                <option value=30>Puzzle</option>
                <option value=31>Party Game</option>
                <option value=32>Match-3</option>
                <option value=33>Quebra-cabeça Lógico</option>
            </optgroup>

            <optgroup label="Música e Ritmo">
                <option value=34>Ritmo</option>
                <option value=35>Karaokê</option>
                <option value=36>Dança</option>
            </optgroup>

            <optgroup label="Outros">
                <option value=37>Visual Novel</option>
                <option value=38>Sandbox</option>
                <option value=39>Educacional</option>
                <option value=40>Idle / Incremental</option>
            </optgroup>
            </select>
            </div>
            <div class="card">
                <p>Console favorito:</p>
                <select id="consoleFavorito" name="console" required onchange="consoleSelecionado(this)">
                <option value="0" selected>Nenhum</option>

                <optgroup label="1ª Geração (década de 1970)">
                    <option value=1>Magnavox Odyssey</option>
                </optgroup>

                <optgroup label="2ª Geração">
                    <option value=2>Atari 2600</option>
                    <option value=3>Intellivision</option>
                    <option value=4>ColecoVision</option>
                </optgroup>

                <optgroup label="3ª Geração">
                    <option value=5>Nintendo Entertainment System (NES)</option>
                    <option value=6>Sega Master System</option>
                </optgroup>

                <optgroup label="4ª Geração">
                    <option value=7>Super Nintendo Entertainment System (SNES)</option>
                    <option value=8>Sega Genesis (Mega Drive)</option>
                    <option value=9>Neo Geo</option>
                </optgroup>

                <optgroup label="5ª Geração">
                    <option value=10>Sony PlayStation</option>
                    <option value=11>Nintendo 64</option>
                    <option value=12>Sega Saturn</option>
                </optgroup>

                <optgroup label="6ª Geração">
                    <option value=13>Sony PlayStation 2</option>
                    <option value=14>Microsoft Xbox</option>
                    <option value=15>Nintendo GameCube</option>
                    <option value=16>Sega Dreamcast</option>
                </optgroup>

                <optgroup label="7ª Geração">
                    <option value=17>Sony PlayStation 3</option>
                    <option value=18>Microsoft Xbox 360</option>
                    <option value=19>Nintendo Wii</option>
                </optgroup>

                <optgroup label="8ª Geração">
                    <option value=20>Sony PlayStation 4</option>
                    <option value=21>Microsoft Xbox One</option>
                    <option value=22>Nintendo Switch</option>
                </optgroup>

                <optgroup label="9ª Geração (atual)">
                    <option value=23>Sony PlayStation 5</option>
                    <option value=24>Microsoft Xbox Series X/S</option>
                </optgroup>
                </select>
            </div>
        </div>

    <h2>Jogos Favoritos</h2>
    <div id="jogosFavoritos" class="jogosFavoritos">
        <fieldset>
            <legend>Plataforma</legend>
            <label><input type="checkbox" name="jogoFavorito" value="1" onchange="checkboxMudou(this)"> Super Mario Bros.</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="3" onchange="checkboxMudou(this)"> Sonic the Hedgehog</label><br>
        </fieldset>

        <fieldset>
            <legend>Aventura de Ação</legend>
            <label><input type="checkbox" name="jogoFavorito" value="2" onchange="checkboxMudou(this)"> The Legend of Zelda</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="26" onchange="checkboxMudou(this)"> Among Us</label><br>
        </fieldset>

        <fieldset>
            <legend>Metroidvania</legend>
            <label><input type="checkbox" name="jogoFavorito" value="4" onchange="checkboxMudou(this)"> Metroid</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="5" onchange="checkboxMudou(this)"> Castlevania: Symphony of the Night</label><br>
        </fieldset>

        <fieldset>
            <legend>JRPG</legend>
            <label><input type="checkbox" name="jogoFavorito" value="6" onchange="checkboxMudou(this)"> Final Fantasy VII</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="7" onchange="checkboxMudou(this)"> Chrono Trigger</label><br>
        </fieldset>

        <fieldset>
            <legend>RPG de Ação</legend>
            <label><input type="checkbox" name="jogoFavorito" value="8" onchange="checkboxMudou(this)"> The Elder Scrolls V: Skyrim</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="19" onchange="checkboxMudou(this)"> Dark Souls</label><br>
        </fieldset>

        <fieldset>
            <legend>MMORPG</legend>
            <label><input type="checkbox" name="jogoFavorito" value="9" onchange="checkboxMudou(this)"> World of Warcraft</label><br>
        </fieldset>

        <fieldset>
            <legend>Simulação de Vida</legend>
            <label><input type="checkbox" name="jogoFavorito" value="10" onchange="checkboxMudou(this)"> Stardew Valley</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="11" onchange="checkboxMudou(this)"> The Sims</label><br>
        </fieldset>

        <fieldset>
            <legend>Simulação de Construção e Gestão</legend>
            <label><input type="checkbox" name="jogoFavorito" value="12" onchange="checkboxMudou(this)"> SimCity 2000</label><br>
        </fieldset>

        <fieldset>
            <legend>Sandbox</legend>
            <label><input type="checkbox" name="jogoFavorito" value="13" onchange="checkboxMudou(this)"> Minecraft</label><br>
        </fieldset>

        <fieldset>
            <legend>Puzzle</legend>
            <label><input type="checkbox" name="jogoFavorito" value="14" onchange="checkboxMudou(this)"> Tetris</label><br>
        </fieldset>

        <fieldset>
            <legend>Quebra-cabeça Lógico</legend>
            <label><input type="checkbox" name="jogoFavorito" value="15" onchange="checkboxMudou(this)"> Portal</label><br>
        </fieldset>

        <fieldset>
            <legend>RTS (Tempo Real)</legend>
            <label><input type="checkbox" name="jogoFavorito" value="16" onchange="checkboxMudou(this)"> League of Legends</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="17" onchange="checkboxMudou(this)"> Age of Empires II</label><br>
        </fieldset>

        <fieldset>
            <legend>4X</legend>
            <label><input type="checkbox" name="jogoFavorito" value="18" onchange="checkboxMudou(this)"> Civilization VI</label><br>
        </fieldset>

        <fieldset>
            <legend>Roguelike / Roguelite</legend>
            <label><input type="checkbox" name="jogoFavorito" value="20" onchange="checkboxMudou(this)"> Hades</label><br>
        </fieldset>

        <fieldset>
            <legend>FPS</legend>
            <label><input type="checkbox" name="jogoFavorito" value="21" onchange="checkboxMudou(this)"> DOOM (1993)</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="22" onchange="checkboxMudou(this)"> Halo: Combat Evolved</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="23" onchange="checkboxMudou(this)"> Overwatch</label><br>
            <label><input type="checkbox" name="jogoFavorito" value="24" onchange="checkboxMudou(this)"> Call of Duty: Modern Warfare</label><br>
        </fieldset>

        <fieldset>
            <legend>Battle Royale</legend>
            <label><input type="checkbox" name="jogoFavorito" value="25" onchange="checkboxMudou(this)"> Fortnite</label><br>
        </fieldset>

        <fieldset>
            <legend>Survival</legend>
            <label><input type="checkbox" name="jogoFavorito" value="27" onchange="checkboxMudou(this)"> Resident Evil 4</label><br>
        </fieldset>

        <fieldset>
            <legend>Hack and Slash</legend>
            <label><input type="checkbox" name="jogoFavorito" value="28" onchange="checkboxMudou(this)"> Bayonetta</label><br>
        </fieldset>

        <fieldset>
            <legend>Ritmo</legend>
            <label><input type="checkbox" name="jogoFavorito" value="29" onchange="checkboxMudou(this)"> Guitar Hero III: Legends of Rock</label><br>
        </fieldset>

        <fieldset>
            <legend>Dança</legend>
            <label><input type="checkbox" name="jogoFavorito" value="30" onchange="checkboxMudou(this)"> Just Dance 2024</label><br>
        </fieldset>
    </div>
        
    <div class="dashboard">
        <div class="graficosConsoles">
            <div id="consoles_pizza">
                <h3>Consoles favoritos dos usuários por geração</h3>
                <canvas id="graficoPizza" width="400" height="400"></canvas>
            </div>
            <div>
                <h3>Consoles mais populares entre os usuários</h3>
                <canvas id="graficoConsoles" width="400" height="400"></canvas>
            </div>
            <div class="graficosGeneros">
                <h3>Genêros mais populares entre os usuários</h3>
                <canvas id="graficoGeneros" width="400" height="400"></canvas>
            </div>
            <div class="graficosJogos">
                <h3>Jogos mais populares entre os usuários</h3>
                <canvas id="graficosJogos" width="400" height="400"></canvas>
            </div>
        </div>
    </div>
    
</body>
</html>
<script src="scripts/navbar.js"></script>
<script src="scripts/dashboard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let graficoJogos = null; // Variável global para armazenar a instância do gráfico
atualizarGraficoJogos();
function graficoJogosFavoritos(){
    fetch("/dashboard/obterDadosJogosFavoritos")
    .then(res => res.json())
    .then(dados => {
        const nomes = dados.map(item => item.nome_jogo);
        const votos = dados.map(item => item.quantidade_usuarios);

        const ctx = document.getElementById("graficosJogos").getContext("2d");
        
        // Destruir o gráfico anterior se existir
        if (graficoJogos) {
            graficoJogos.destroy();
        }
        
        graficoJogos = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: nomes,
                datasets: [{
                    label: 'Quantidade de usuários',
                    data: votos,
                    backgroundColor: [
                        '#E6194B', '#3CB44B', '#FFE119', '#4363D8', 
                        '#F58231', '#911EB4', '#46F0F0', '#F032E6',
                        '#BCF60C', '#FABEBE'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: 'white',
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000
                }
            }
        });
    })
    .catch(error => {
        console.error('Erro ao obter dados:', error);
    });
}

// Inserir Jogos Favoritos
function checkboxMudou(checkbox) {
  if (checkbox.checked) {
    const opcaoSelecionada = checkbox.value;
    console.log("Console Marcado:", opcaoSelecionada);
    console.log(sessionStorage.EMAIL_USUARIO);

    fetch("/opinioes/cadastrarJogoFavorito", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            console_jogoFavoritoServer: opcaoSelecionada,
            console_idUsuarioServer: sessionStorage.ID_USUARIO
        }),
    })
    .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
            console.log(`<p class="verde">👍 Jogo Enviado com Sucesso!</p>`);
            console.log("Console:" + sessionStorage.CONSOLE_USUARIO);
        } else {
            throw "Houve um erro ao tentar realizar o cadastro do console!";
        }
    })
    .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
    });
  } else {
    const opcaoSelecionada = checkbox.value;
    console.log("Console Marcado:", opcaoSelecionada);
    console.log(sessionStorage.EMAIL_USUARIO);

    fetch("/opinioes/removerJogoFavorito", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({
            console_jogoFavoritoServer: opcaoSelecionada,
            console_idUsuarioServer: sessionStorage.ID_USUARIO
        }),
    })
    .then(function (resposta) {
        console.log("resposta: ", resposta);

        if (resposta.ok) {
            console.log(`<p class="verde">👍 Jogo Removido com Sucesso!</p>`);
            console.log("Console:" + sessionStorage.CONSOLE_USUARIO);
        } else {
            throw "Houve um erro ao tentar realizar o cadastro do console!";
        }
    })
    .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);
    });
  }
}

// Puxar Jogos Favoritos

function atualizarGraficoJogos(){
    fetch(`/dashboard/obterDadosJogosFavoritos`, { cache: 'no-store' })
    .then(function (response) {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Erro na resposta da API');
    })
    .then(function (resposta) {
        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
        resposta.reverse();
        graficoJogosFavoritos();
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados: ${error.message}`);
    });
}
setInterval(atualizarGraficoJogos, 10000);


function atualizarSelects() {
    const idUsuario = sessionStorage.ID_USUARIO;
    
    if (!idUsuario) {
        console.error("ID do usuário não encontrado!");
        return;
    }

    fetch(`/dashboard/atualizarSelects?idUsuario=${idUsuario}`, { 
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(function (response) {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Erro na resposta da API');
    })
    .then(function (resposta) {
        console.log(`Jogos favoritos do usuário: ${JSON.stringify(resposta)}`);
        
        document.querySelectorAll('input[name="jogoFavorito"]').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        resposta.forEach(jogo => {
            const checkbox = document.querySelector(`input[name="jogoFavorito"][value="${jogo.fkIdJogoFavorito}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    })
    .catch(function (error) {
        console.error(`Erro ao obter jogos favoritos: ${error.message}`);
    });
}

// Chamar a função quando a página carregar
document.addEventListener('DOMContentLoaded', function() {
    // Certifique-se que o ID_USUARIO está no sessionStorage
    if (sessionStorage.ID_USUARIO) {
        atualizarSelects();
    } else {
        console.error("Usuário não autenticado");
    }
});
</script>